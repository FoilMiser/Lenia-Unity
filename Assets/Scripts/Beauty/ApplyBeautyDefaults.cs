namespace LeniaBeauty{using UnityEngine;using UnityEngine.UI;using System;using System.Reflection;using System.Collections;public class ApplyBeautyDefaults:MonoBehaviour{[RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.AfterSceneLoad)]static void Install(){var go=new GameObject("LeniaBeautyDefaults");UnityEngine.Object.DontDestroyOnLoad(go);go.AddComponent<ApplyBeautyDefaults>();}IEnumerator Start(){yield return new WaitForSeconds(0.5f);ApplyAll();yield return new WaitForEndOfFrame();ApplyAll();}void ApplyAll(){var neon=BuildNeon();var lut=BuildLUT(neon,512);int comps=0, mats=0, texSet=0, floatSet=0;var list=UnityEngine.Object.FindObjectsByType<MonoBehaviour>(FindObjectsInactive.Include,FindObjectsSortMode.None);foreach(var mb in list){bool touched=false;touched|=TrySetGradient(mb,neon);touched|=TrySetMany(mb,new[]{"DispExposure","Exposure","dispExposure"},new object[]{5.8f,5.8f,5.8f});touched|=TrySetMany(mb,new[]{"DispGamma","Gamma","dispGamma"},new object[]{1.05f,1.05f,1.05f});touched|=TrySetMany(mb,new[]{"PaletteScale","paletteScale"},new object[]{0.84f,0.84f});touched|=TrySet(mb,"lut",lut);touched|=TryAssignToMaterial(mb,lut,ref mats,ref texSet,ref floatSet);if(touched){TryInvoke(mb,new[]{"RebuildLUT","RebuildLut","ApplyPalette","ApplyParams","Apply","OnValidate"});comps++;}}var cam=Camera.main;if(cam){cam.allowHDR=true;cam.clearFlags=CameraClearFlags.SolidColor;cam.backgroundColor=FromHex("#02040A");}Debug.Log($"[Beauty] Forced apply: comps={comps}, mats={mats}, texSet={texSet}, floatSet={floatSet}");}bool TryAssignToMaterial(MonoBehaviour mb,Texture2D lut,ref int mats,ref int texSet,ref int floatSet){bool any=false;Material m=null; // 1) Try field "mat"
var tp=mb.GetType();var f=tp.GetField("mat",BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic|BindingFlags.IgnoreCase);if(f!=null&&typeof(Material).IsAssignableFrom(f.FieldType))m=f.GetValue(mb) as Material; // 2) Try a RawImage on same GO
if(m==null){var ri=mb.GetComponent<RawImage>(); if(ri!=null) m=ri.material;} // 3) Try a Renderer
if(m==null){var r=mb.GetComponent<Renderer>(); if(r!=null) m=r.material;} if(m==null) return false; mats++; // set LUT on common property names
int[] texIDs=new[]{Shader.PropertyToID("_PaletteTex"),Shader.PropertyToID("_Palette"),Shader.PropertyToID("_LUT"),Shader.PropertyToID("_Lut"),Shader.PropertyToID("_LUTTex"),Shader.PropertyToID("_GradientTex")}; foreach(var id in texIDs){ if(m.HasProperty(id)){ m.SetTexture(id,lut); texSet++; any=true; break; } } // nudge common float properties if they exist
int[] fIDs=new[]{Shader.PropertyToID("_Exposure"),Shader.PropertyToID("_Gamma"),Shader.PropertyToID("_PaletteScale"),Shader.PropertyToID("_EdgeStrength"),Shader.PropertyToID("_EdgeThreshold")}; float[] fVals=new[]{5.8f,1.05f,0.84f,0.45f,0.0105f}; for(int i=0;i<fIDs.Length;i++){ if(m.HasProperty(fIDs[i])){ m.SetFloat(fIDs[i],fVals[i]); floatSet++; any=true; } } return any; }bool TrySetMany(MonoBehaviour t,string[] keys,object[] vals){bool any=false;for(int i=0;i<keys.Length&&i<vals.Length;i++){if(TrySet(t,keys[i],vals[i]))any=true;}return any;}bool TrySet(MonoBehaviour t,string key,object val){var tp=t.GetType();var f=tp.GetField(key,BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic|BindingFlags.IgnoreCase);if(f!=null){try{f.SetValue(t,ConvertTo(val,f.FieldType));return true;}catch{}}var p=tp.GetProperty(key,BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic|BindingFlags.IgnoreCase);if(p!=null&&p.CanWrite){try{p.SetValue(t,ConvertTo(val,p.PropertyType));return true;}catch{}}return false;}bool TrySetGradient(MonoBehaviour t,Gradient g){var tp=t.GetType();foreach(var name in new[]{"palette","Palette","gradient","Gradient"}){var f=tp.GetField(name,BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic|BindingFlags.IgnoreCase);if(f!=null&&f.FieldType==typeof(Gradient)){try{f.SetValue(t,g);}catch{}return true;}var p=tp.GetProperty(name,BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic|BindingFlags.IgnoreCase);if(p!=null&&p.CanWrite&&p.PropertyType==typeof(Gradient)){try{p.SetValue(t,g);}catch{}return true;}}return false;}void TryInvoke(MonoBehaviour t,string[] names){var tp=t.GetType();foreach(var n in names){var m=tp.GetMethod(n,BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic|BindingFlags.IgnoreCase,System.Type.DefaultBinder,System.Type.EmptyTypes,null);if(m!=null){try{m.Invoke(t,null);}catch{}}}}object ConvertTo(object v,System.Type t){if(t==typeof(Color)){if(v is string s&&ColorUtility.TryParseHtmlString(s,out var c))return c;if(v is Color c2)return c2;}if(t.IsEnum)return System.Enum.ToObject(t,v);return System.Convert.ChangeType(v,t);}Texture2D BuildLUT(Gradient g,int steps){var tex=new Texture2D(steps,1,TextureFormat.RGBA32,false,true){wrapMode=TextureWrapMode.Clamp,filterMode=FilterMode.Bilinear};for(int i=0;i<steps;i++){float t=(float)i/(steps-1);tex.SetPixel(i,0,g.Evaluate(t));}tex.Apply(false,false);return tex;}Color FromHex(string hex){Color c;if(!ColorUtility.TryParseHtmlString(hex,out c))c=Color.black;return c;}Gradient BuildNeon(){var g=new Gradient();g.SetKeys(new[]{new GradientColorKey(FromHex("#000005"),0f),new GradientColorKey(FromHex("#00141C"),0.05f),new GradientColorKey(FromHex("#0AE7FF"),0.30f),new GradientColorKey(FromHex("#FFFFFF"),0.55f),new GradientColorKey(FromHex("#FF66FF"),0.80f),new GradientColorKey(FromHex("#2A002A"),1f)},new[]{new GradientAlphaKey(1f,0f),new GradientAlphaKey(1f,1f)});return g;}}}
